# Критерии приёмки: круглосуточная доступность Telegram-бота

Документ описывает, **что необходимо сделать**, чтобы бот соответствовал критериям приёмки по доступности 24/7 независимо от состояния локального оборудования.

---

## Почему текущая схема не удовлетворяет критериям

Сейчас бот запускается **на локальном компьютере** (Mac/PC) с помощью:

- `screen` / `tmux` / `nohup` — процесс живёт только пока живёт машина
- `launchd` (macOS) — перезапускает бота при сбое, но **не при выключении или отключении питания**

Как только компьютер выключен, перезагружен или произошёл сбой питания — **бот недоступен**. Критерии 1 и 2 при такой схеме выполнить **невозможно**.

**Вывод:** для выполнения критериев бот должен работать **не на вашем ПК**, а на **постоянно включённом удалённом сервере** (VPS или PaaS).

---

## Что нужно сделать: общий план

| Критерий | Что требуется |
|----------|----------------|
| **Сценарий 1** (долгосрочная доступность) | Запускать бота на **удалённом сервере** (VPS или PaaS), который работает 24/7 |
| **Сценарий 2** (устойчивость к сбоям) | На сервере — **автоперезапуск** при падении процесса (systemd, supervisord или встроенный в PaaS) |
| **Сценарий 3** (плавное обновление) | Быстрый перезапуск (< 30 сек) и/или деплой без простоя (blue-green, rolling) |

Ниже — конкретные шаги по вариантам размещения.

---

## Вариант 1: VPS (рекомендуется для полного контроля)

**Подходит:** если готовы арендовать виртуальный сервер (DigitalOcean, Timeweb, Selectel, Hetzner и т.п.).

### Шаги

1. **Арендовать VPS**  
   - Linux (Ubuntu 22.04 или аналог).  
   - Минимум: 1 CPU, 512 MB RAM (для одного бота обычно достаточно).

2. **Развернуть бота на сервере**
   - Установить Python 3, склонировать/скопировать проект, настроить `.env` (токен, chat_id и др.).
   - Установить зависимости: `pip install -r requirements.txt`.

3. **Запускать бота как системный сервис (systemd)**  
   Это даёт:
   - автозапуск после перезагрузки сервера;
   - автоперезапуск при падении процесса (сценарий 2).

   Пример unit-файла `/etc/systemd/system/telegram-vacancy-bot.service`:

   ```ini
   [Unit]
   Description=Telegram Vacancy Bot
   After=network.target

   [Service]
   Type=simple
   User=ubuntu
   WorkingDirectory=/home/ubuntu/hr_app
   EnvironmentFile=/home/ubuntu/hr_app/.env
   ExecStart=/usr/bin/python3 /home/ubuntu/hr_app/telegram_vacancy_bot.py
   Restart=always
   RestartSec=10

   [Install]
   WantedBy=multi-user.target
   ```

   Команды:

   ```bash
   sudo systemctl daemon-reload
   sudo systemctl enable telegram-vacancy-bot
   sudo systemctl start telegram-vacancy-bot
   sudo systemctl status telegram-vacancy-bot
   ```

   При падении процесса systemd перезапустит его через 10 секунд — укладываемся в «5 минут» из сценария 2.

4. **Деплой новой версии (сценарий 3)**
   - Остановить сервис, обновить код, запустить снова. Простой обычно 5–30 секунд.
   - Чтобы уложиться в «не более 30 секунд»: скрипт деплоя должен только обновлять файлы и делать `systemctl restart telegram-vacancy-bot` без лишних действий.

### Итог по критериям на VPS

- **Сценарий 1:** выполняется — сервер работает 24/7, бот на нём тоже.
- **Сценарий 2:** выполняется — `Restart=always` обеспечивает восстановление без ручного вмешательства.
- **Сценарий 3:** выполняется при быстром рестарте (типично < 30 сек).

---

## Вариант 2: PaaS (Railway, Render, Fly.io и т.п.)

**Подходит:** если не хотите администрировать сервер; важна простота деплоя.

### Общая идея

- Репозиторий подключается к платформе, деплой по push в Git.
- Платформа сама держит процесс живым и перезапускает при падении (сценарий 2).
- Обычно есть бесплатный или недорогой тариф.

### Шаги (на примере Railway / Render)

1. **Создать приложение** из репозитория с ботом.
2. **Задать переменные окружения** в панели (TELEGRAM_BOT_TOKEN, TELEGRAM_CHAT_ID, OPENAI_API_KEY и т.д.).
3. **Указать команду запуска**, например:  
   `python3 telegram_vacancy_bot.py`
4. **Проверить**, что платформа не «засыпает» бесплатное приложение надолго (иначе бот будет недоступен — нарушение сценария 1). При необходимости — платный тариф без сна.

**Подробная пошаговая инструкция по размещению на Railway:** см. [RAILWAY_DEPLOYMENT.md](RAILWAY_DEPLOYMENT.md).

### Деплой (сценарий 3)

- Обычно новый деплой = останов старого процесса + запуск нового. Простой чаще всего в пределах 30 секунд.
- На части платформ есть health checks и постепенный переключение — это дополнительно снижает видимый простой.

### Итог по критериям на PaaS

- **Сценарий 1:** выполняется при условии, что инстанс не выключается (выбор тарифа без «сна»).
- **Сценарий 2:** выполняется — платформа перезапускает упавший процесс.
- **Сценарий 3:** выполняется при типичном времени перезапуска платформы (< 30 сек).

---

## Вариант 3: Webhook вместо long polling (опционально)

Сейчас бот использует **long polling** (`application.run_polling()`). Для 24/7 критериев это не мешает: и на VPS, и на PaaS polling работает нормально.

Переход на **webhook** имеет смысл, если:

- хотите разгрузить сервер (не держать постоянное соединение);
- или планируете serverless (AWS Lambda, Yandex Cloud Functions и т.п.).

Для webhook нужны:

- Публичный HTTPS-адрес (на VPS — nginx + SSL; на PaaS часто уже есть).
- Небольшие изменения в коде: запуск через `run_webhook()` вместо `run_polling()` и настройка URL.

Для выполнения **описанных** критериев приёмки webhook не обязателен: достаточно переноса на VPS/PaaS с автоперезапуском и быстрым деплоем.

---

## Чек-лист по критериям приёмки

Перед сдачей проверьте:

- [ ] Бот запущен **не на локальном ПК**, а на **постоянно работающем удалённом сервере** (VPS или PaaS).
- [ ] При падении процесса бот **автоматически перезапускается** (systemd/supervisord или механизм PaaS).
- [ ] После выключения локального компьютера бот **продолжает отвечать** на команды (например, /start, /help).
- [ ] Деплой новой версии выполняется так, что **простой не превышает 30 секунд** (скрипт деплоя с быстрым restart или настройки PaaS).

---

## Краткая сводка

| Требование | Действие |
|------------|----------|
| Круглосуточная доступность | Разместить бота на VPS или PaaS, а не на локальном компьютере. |
| Устойчивость к сбоям | Включить автоперезапуск (systemd с `Restart=always` или аналог на PaaS). |
| Плавное обновление | Настроить быстрый деплой (restart сервиса или перезапуск контейнера за < 30 сек). |

Без переноса бота на удалённый сервер критерии приёмки по круглосуточной доступности и независимости от локального оборудования **выполнить невозможно**.
